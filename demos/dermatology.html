<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>HPCC Systems - Dermatology Test</title>
    <link rel="stylesheet" href="graph/css/style.css">
    <style>
        body {
            margin: 0px;
            padding: 0px;
            font: 14px/1.5 Lato, "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color:white;
            font-weight: 300;
            overflow:hidden;
        }
    </style>
    <script src="http://rawgit.com/jrburke/requirejs/2.1.17/require.js"></script>
    <script src="../src/config.js"></script>
    <!--  Uncomment for github
    <script src="http://rawgit.com/jrburke/requirejs/2.1.17/require.js"></script>
    <script src="../src/config.js"></script>
    -->
    <!--  Uncomment to develop
    <script src="../bower_components/requirejs/require.js"></script>
    <script src="../src/config.js"></script>
    -->
    <!--  Uncomment to test build
    <script src="../dist-amd/hpcc-viz.js"></script>
    <script src="../dist-amd/hpcc-bundles.js"></script>
    <script>
        require.config({
            paths: {
                "src": "../dist-amd",
                "font-awesome": "../dist-amd/font-awesome/css/font-awesome.min"
            }
        });
    </script>
    -->

    <script>
        require.config({
            paths: {
                "test": "../test"
            }
        });
    </script>
</head>
<body onresize="doResize();">
    <header>
        <div class="container">
            <h1><a>Dermatology</a></h1>
            <nav>
                <ul>
                    <li>
                        <prompt>Widget:</prompt>
                        <select id="widgetSelect" onchange="testWidget(this.value);">
                        </select>
                    </li>
                    <li>
                        <label for="showProperties">&nbsp;&nbsp;Properties:</label>
                        <input id="showProperties" type="checkbox" checked onchange="showProperties(this.checked);" />
                    </li>
                    <li>
                        <label for="showSerialization">&nbsp;&nbsp;S. Test:</label>
                        <input id="showSerialization" type="checkbox" onchange="showSerialization(this.checked);" />
                    </li>
                    <li>
                        <label for="showSerialization">&nbsp;&nbsp;S. Text:</label>
                        <input id="showSerializationText" type="checkbox" onchange="showSerializationText(this.checked);" />
                    </li>
                    <li>
                        <label for="showThemeText">&nbsp;&nbsp;Theme Text:</label>
                        <input id="showThemeText" type="checkbox" onchange="showThemeText(this.checked);" />
                    </li>
                    <li>
                        <prompt style="margin-left:8px;">Theme:</prompt>
                        <select id="themeSelect" onchange="testTheme(this.value);">
                            <option value="Default">Default</option>
                            <option value="LN Red/Grey">LN Red/Grey</option>
                            <option value="Green/Light-Grey">Green/Light-Grey</option>
                            <option value="Blue-Bordered">Blue-Bordered</option>
                            <option value="Red-Bordered">Red-Bordered</option>
                        </select>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    <div id="main" style="width:100%; height:100vh;margin-top:40px;padding:8px;overflow:hidden">
    </div>
    <script>
        var def = window.location.search.split("?")[1];
        var widgetPath = "";
        var params = {};
        if (def) {
            def.split("&").forEach(function (param, idx) {
                var paramParts = param.split("=");
                if (paramParts[0] === "hpcc_debug") {
                    window.__hpcc_debug = paramParts[1];
                } else if (widgetPath === "" && paramParts.length === 1) {
                    widgetPath = decodeURIComponent(paramParts[0]);
                } else {
                    params[decodeURIComponent(paramParts[0])] = decodeURIComponent(paramParts[1]);
                }
            });
            if (widgetPath) {
                document.getElementById("widgetSelect").value = widgetPath;
            }
        }
        var themeSelectObj = {
            'Default':{},
            'LN Red/Grey':{"common_Widget":{"surfaceTitleFontSize":16,"surfaceTitleFontColor":"#FAFAFA","surfaceTitleFontFamily":"PT Sans","surfaceTitleFontBold":false,"surfaceTitleBackgroundColor":"#ED1C24","surfacePadding":"null","surfaceBackgroundColor":"#FAFAFA","surfaceBorderWidth":1,"surfaceBorderColor":"#6D6E71","surfaceBorderRadius":4,"surfaceTitleAlignment":"center","paletteID":"Set1"}},
            'Blue-Bordered':{"common_Widget":{"surfaceTitlePadding":0,"surfaceTitleFontSize":16,"surfaceTitleFontColor":"#5a6b92","surfaceTitleFontFamily":"'Courier New'","surfaceTitleFontBold":false,"surfaceTitleBackgroundColor":"transparent","surfacePadding":"null","surfaceBackgroundColor":"transparent","surfaceBorderWidth":2,"surfaceBorderColor":"#5a6b92","surfaceBorderRadius":0,"surfaceTitleAlignment":"left","paletteID":"Dark2","axisFontSize":14,"axisFontFamily":"Tahoma","xAxisTitleFontFamily":"'Courier New'","yAxisTitleFontFamily":"'Courier New'","legendFontSize":14,"legendFontFamily":"Tahoma"}},
            'Red-Bordered':{"common_Widget":{"surfaceTitleFontSize":19,"surfaceTitleFontColor":"rgb(237, 28, 36)","surfaceTitleFontFamily":"'Arial Black'","surfaceTitleBackgroundColor":"rgb(250, 250, 250)","surfacePadding":"null","surfaceBackgroundColor":"rgb(250, 250, 250)","surfaceBorderColor":"rgb(237, 28, 36)","paletteID":"BrBG","axisFontFamily":"'Arial Black'","xAxisTitleFontFamily":"'Arial Black'","xAxisTitleFontSize":19,"yAxisTitleFontFamily":"'Arial Black'","yAxisTitleFontSize":19,"legendFontFamily":"'Arial Black'"}},
            'Green/Light-Grey':{"common_Widget":{"surfaceTitlePadding":0,"surfaceTitleFontSize":16,"surfaceTitleFontColor":"#4e4e4e","surfaceTitleFontFamily":"Tahoma","surfaceTitleFontBold":false,"surfaceTitleBackgroundColor":"#dbb593","surfacePadding":"null","surfaceBackgroundColor":"#e2e2dc","surfaceBorderWidth":0,"surfaceBorderColor":"#ffffff","surfaceBorderRadius":0,"surfaceTitleAlignment":"left","paletteID":"category10","axisFontSize":14,"axisFontFamily":"Tahoma","xAxisTitleFontFamily":"Tahoma","yAxisTitleFontFamily":"Tahoma","legendFontSize":14,"legendFontFamily":"Tahoma"}},
        }
        window.__hpcc_theme = themeSelectObj['Default'];

        var body = document.getElementById("body");
        var mainDiv = document.getElementById("main");
        var frame = null;
        var main = null;
        var testTheme = null;
        var testWidget = null;
        var currWidget = null;
        var showProperties = null;
        var debouncedResize = null;

        require(["d3", "src/layout/Surface", "src/layout/Grid", "src/other/Persist", "src/other/PropertyEditor", "test/Factory"], function (d3, Surface, Grid, Persist, PropertyEditor, testFactory) {
            var samples = [];
            testFactory.categories.forEach(function (category) {
                category.widgets.forEach(function(widget) {
                    widget.samples.forEach(function (sample) {
                        samples.push({
                            category: category,
                            widget: widget,
                            sample: sample
                        })
                    });
                });
            });
            var sampleSelect = d3.select("#widgetSelect");
            var sampleOptions = sampleSelect.selectAll("option").data(samples);
            sampleOptions.enter()
                .append("option")
                .attr("value", function (d, idx) { return idx; })
                .text(function (d) { return "[" + d.category.label + "] " + d.widget.label + " - " + d.sample.label; })
            ;
            var propEditor = new PropertyEditor().showColumns(false).showData(false);
            propEditor.onChange =  Surface.prototype.debounce(function (widget, propID) {
                if (propID === "columns") {
                } else if (propID === "data") {
                } else {
                    displaySerialization();
                    displaySerializationText();
                    displayThemeText();
                }
            }, 500);
            var serializationSurface = new Surface()
            ;
            var themeTextSurface = new Surface()
                .id("testThemeJSON")
            ;
            var serializationTextSurface = new Surface()
                .id("testJSON")
            ;
            main = new Grid()
                .setContent(0, 2, propEditor, "", 2, 1)
                .cellPadding(0)
            ;

            frame = new Surface()
                .widget(main)
                .target("main")
                .surfacePadding(0)
            ;

            function displayProperties(sourceWidget) {
                if (document.getElementById("showProperties").checked) {
                    sourceWidget = sourceWidget || currWidget;
                    propEditor
                        .data([sourceWidget])
                        .render()
                    ;
                }
            }

            function displaySerialization(sourceWidget) {
                if (document.getElementById("showSerialization").checked) {
                    sourceWidget = sourceWidget || currWidget;
                    Persist.clone(sourceWidget, function (widget) {
                        serializationSurface
                            .surfacePadding(0)
                            .widget(widget)
                            .render()
                        ;
                    });
                }
            }

            function displaySerializationText(sourceWidget) {
                if (document.getElementById("showSerializationText").checked) {
                    sourceWidget = sourceWidget || currWidget;
                    var text = JSON.stringify(Persist.serializeToObject(sourceWidget, null, false), null, "  ");
                    d3.select("#testJSON")
                        .attr("class", "prettyprint")
                        .text(text)
                    ;
                }
            }

            function displayThemeText(sourceWidget) {
                if (document.getElementById("showThemeText").checked) {
                    sourceWidget = sourceWidget || currWidget;
                    var text = JSON.stringify(Persist.serializeThemeToObject(sourceWidget), null, "  ");
                    d3.select("#testThemeJSON")
                        .attr("class", "prettyprint")
                        .text(text)
                    ;
                }
            }

            testWidget = function (idx, params) {
                testFactory.create(samples[idx].category.factory, samples[idx].widget.id, samples[idx].sample.id, function(widget) {
                    currWidget = widget;
//                    console.log(widget);
                    if (params) {
                        for (var key in params) {
                            currWidget[key](params[key]);
                        }
                    }
                    main
                        .setContent(0, 0, currWidget, "", 2, 2)
                    ;
                    frame
                        .title(widgetPath)
                        .render(function (mainWidget) {
                            displayProperties(currWidget);
                            displaySerialization(currWidget);
                            displaySerializationText(currWidget);
                            displayThemeText(currWidget);
                        })
                    ;
                });
            };
            testTheme = function (themeKey) {
                window.__hpcc_theme = themeSelectObj[themeKey];
                Persist.removeTheme(currWidget,function(){
                    Persist.applyTheme(currWidget,themeSelectObj[themeKey],function(){
                        currWidget.render();
                        displayProperties(currWidget);
                        displaySerialization(currWidget);
                        displaySerializationText(currWidget);
                        displayThemeText(currWidget);
                    });
                })
            }
            showProperties = function (show) {
                main
                    .setContent(0, 2, show ? propEditor : null, "", 2, 1)
                    .render(function (widget) {
                        if (show) {
                            displayProperties();
                        }
                    })
                ;
            }
            showSerialization = function (show) {
                main
                    .setContent(2, 0, show ? serializationSurface : null, "", 1, 3)
                    .render(function (widget) {
                        if (show) {
                            displaySerialization();
                        }
                    })
                ;
            }
            showSerializationText = function (show) {
                main
                    .setContent(0, 3, show ? serializationTextSurface : null, "", 2, 1)
                    .render(function (widget) {
                        if (show) {
                            displaySerializationText();
                        }
                    })
                ;
            }
            showThemeText = function (show) {
                main
                    .setContent(2, 3, show ? themeTextSurface : null, "", 1, 1)
                    .render(function (widget) {
                        if (show) {
                            displayThemeText();
                        }
                    })
                ;
            }
            var first = true;
            frame.doResize = Surface.prototype.debounce(function () {
                mainDiv.style.width = window.innerWidth - 16 + "px";
                mainDiv.style.height = window.innerHeight - 16 - 40 + "px";
                this
                    .resize()
                    .render()
                ;
                if (first) {
                    first = false;
                    testWidget(document.getElementById("widgetSelect").value, params);
                }
            }, 250)
            frame.doResize();
        });
        function doResize() {
            if (frame) {
                frame.doResize();
            }
        }
    </script>
</body>
</html>
