(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/SVGWidget","../common/Utility","css!./XYAxis"],t):e.chart_XYAxis=t(e.d3,e.common_SVGWidget,e.common_Utility)})(this,function(e,t,n){function r(n){t.call(this),this._drawStartPos="origin",this._dateParserData=e.time.format("%Y-%m-%d").parse,this._dateParserValue=e.time.format("%Y-%m-%d").parse}r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype._class+=" chart_XYAxis",r.prototype.publish("orientation","horizontal","set","Selects orientation for the axis",["horizontal","vertical"]),r.prototype.publish("selectionMode",!1,"boolean","Range Selector"),r.prototype.publish("xAxisTickCount",null,"number","X-Axis Tick Count",null,{optional:!0}),r.prototype.publish("xAxisTickFormat",null,"string","X-Axis Tick Format",null,{optional:!0}),r.prototype.publish("xAxisType","ordinal","set","X-Axis Type",["ordinal","linear","time"]),r.prototype.publish("xAxisTypeTimePattern","%Y-%m-%d","string","Time Series Pattern"),r.prototype.publish("xAxisDomainLow","","string","X-Axis Low"),r.prototype.publish("xAxisDomainHigh","","string","X-Axis High"),r.prototype.publish("xAxisOverlapMode","stagger","set","X-Axis Label Overlap Mode",["none","stagger","hide","rotate"]),r.prototype.publish("xAxisLabelRotation",null,"number","X-Axis Label Rotation"),r.prototype.publish("yAxisTitle","","string","Y-Axis Title"),r.prototype.publish("yAxisTickCount",null,"number","Y-Axis Tick Count",null,{optional:!0}),r.prototype.publish("yAxisTickFormat",null,"string","Y-Axis Tick Format",null,{optional:!0}),r.prototype.publish("yAxisType","linear","set","Y-Axis Type",["none","linear","pow","log","time"]),r.prototype.publish("yAxisTypeTimePattern","%Y-%m-%d","string","Time Series Pattern"),r.prototype.publish("yAxisTypePowExponent",2,"number","Exponent for Pow on Value Axis"),r.prototype.publish("yAxisTypeLogBase",10,"number","Base for log on Value Axis"),r.prototype.publish("yAxisDomainLow","","string","Y-Axis Low"),r.prototype.publish("yAxisDomainHigh","","string","Y-Axis High"),r.prototype.publish("yAxisDomainPadding",5,"number","Y-Axis Low/High Padding (if no low/high specified"),r.prototype.publish("sortDates",!1,"boolean","Sort date field for timeseries data"),r.prototype.publish("regions",[],"array","Regions"),r.prototype.publish("sampleData","","set","Display Sample Data",["","ordinal","ordinalRange","linear","time-x","time-y"]),r.prototype.resetSelection=function(){return this._prevBrush=null,this};var i=r.prototype.xAxisTypeTimePattern;r.prototype.xAxisTypeTimePattern=function(t){var n=i.apply(this,arguments);return arguments.length&&(this._dateParserData=e.time.format(t).parse),n};var s=r.prototype.yAxisTypeTimePattern;return r.prototype.yAxisTypeTimePattern=function(t){var n=s.apply(this,arguments);return arguments.length&&(this._dateParserValue=e.time.format(t).parse),n},r.prototype.columns=function(e){return t.prototype.columns.apply(this,arguments)},r.prototype.formatData=function(e){switch(this.xAxisType()){case"time":return this._dateParserData(typeof e=="number"?e.toString():e);default:return e}},r.prototype.formatValue=function(e){if(!e)return e;if(e instanceof Array)return e.map(function(e){return this.formatValue(e)},this);switch(this.yAxisType()){case"time":return this._dateParserValue(typeof e=="number"?e.toString():e);default:if(typeof e=="string")return+e;return e}},r.prototype.formattedData=function(){return this.data().map(function(e){return e.map(function(e,t){return t===0?this.formatData(e):t>=this.columns().length?e:this.formatValue(e)},this)},this)},r.prototype.enter=function(r,i){t.prototype.enter.apply(this,arguments),this.dataAxis=e.svg.axis().orient("bottom"),this.valueAxis=e.svg.axis().orient("left"),this.svg=i.append("g"),this.svgRegions=i.append("g"),this.svgData=this.svg.append("g"),this.svgXAxis=this.svg.append("g"),this.svgXAxisText=this.svgXAxis.append("text").attr("y",-2).style("text-anchor","end"),this.svgYAxis=this.svg.append("g"),this.svgYAxisText=this.svgYAxis.append("text").attr("transform","rotate(-90)").attr("x",-2).attr("y",2).attr("dy",".71em").style("text-anchor","end"),this.svgBrush=i.append("g").attr("class","brush");var s=this;this.xBrush=e.svg.brush().on("brush",function(){return s.brushMoved.apply(s,arguments)}),this.yBrush=e.svg.brush().on("brush",function(){return s.brushMoved.apply(s,arguments)}),this._selection=new n.SimpleSelection(this.svgData)},r.prototype.resizeBrushHandle=function(e,t,n){var r,i,s;return e==="e"||e==="w"?(r=+(e==="e"),i=r?1:-1,s=n/3,"M"+.5*i+","+s+"A6,6 0 0 "+r+" "+6.5*i+","+(s+6)+"V"+(2*s-6)+"A6,6 0 0 "+r+" "+.5*i+","+2*s+"Z"+"M"+2.5*i+","+(s+8)+"V"+(2*s-8)+"M"+4.5*i+","+(s+8)+"V"+(2*s-8)):(r=+(e==="s"),s=r?1:-1,i=t/3,"M"+i+", "+.5*s+"A6,6 0 0 "+(r+1)%2+" "+(i+6)+","+6.5*s+"H"+(2*i-6)+"A6,6 0 0 "+(r+1)%2+" "+2*i+","+.5*s+"Z"+"M"+(i+8)+","+2.5*s+"H"+(2*i-8)+"M"+(i+8)+","+4.5*s+"H"+(2*i-8))},r.prototype.brushMoved=t.prototype.debounce(function(){var t=this.formattedData().filter(function(e){var t;switch(this.xAxisType()){case"ordinal":return t=this.dataScale(e[0])+(this.dataScale.rangeBand?this.dataScale.rangeBand()/2:0),this.orientation()==="horizontal"?t>=this.xBrush.extent()[0]&&t<=this.xBrush.extent()[1]:t>=this.yBrush.extent()[0]&&t<=this.yBrush.extent()[1];default:return t=e[0],this.orientation()==="horizontal"?t>=this.xBrush.extent()[0]&&t<=this.xBrush.extent()[1]:t>=this.yBrush.extent()[0]&&t<=this.yBrush.extent()[1]}},this);this.selection(t)},250),r.prototype.dataPos=function(e){var t=this.dataScale(this.formatData(e));return this.xAxisType()==="ordinal"&&(t+=this.dataScale.rangeBand()/2),t},r.prototype.valuePos=function(e){return this.valueScale(this.formatValue(e))},r.prototype.setScaleRange=function(e,t){this.currScale.rangeRoundBands?this.currScale.rangeRoundBands([0,e],.1):this.currScale.rangeRound&&this.currScale.range([0,e]),this.otherScale.rangeRoundBands?this.otherScale.rangeRoundBands([t,0],.1):this.otherScale.rangeRound&&this.otherScale.range([t,0])},r.prototype.adjustXAxisText=function(t,n){switch(this.xAxisOverlapMode()){case"stagger":t.selectAll(".tick > text").style("text-anchor","middle").attr("dy",function(e,t){return.71+t%n.overlapModulus+"em"}).attr("dx",0).attr("visibility",null).attr("transform","rotate(0)");break;case"hide":t.selectAll(".tick > text").style("text-anchor","middle").attr("dy","0.71em").attr("dx",0).attr("visibility",function(e,t){return t%n.overlapModulus?"hidden":null}).attr("transform","rotate(0)");break;case"rotate":var r=-this.xAxisLabelRotation()||0;if(r!==0&&n.overlapModulus>1){t.selectAll(".tick > text").each(function(){var t=e.select(this),n=t.node().getBBox(),i=Math.sin(Math.PI*(-Math.abs(r)/180));t.style("text-anchor",r>0?"start":"end").attr("dy",n.height/2*i+"px").attr("dx",r>0?"0.71em":"-0.71em").attr("transform","rotate("+r+")").attr("visibility",null)});break};default:t.selectAll(".tick > text").style("text-anchor","middle").attr("dy","0.71em").attr("dx",0).attr("visibility",null).attr("transform","rotate(0)")}},r.prototype.calcMargin=function(e,t,n){var r={top:this.selectionMode()?10:2,right:this.selectionMode()?10:2,bottom:this.selectionMode()?10:2,left:this.selectionMode()?10:2,overlapModulus:1},i=this.height()-r.top-r.bottom,s=t.append("g");this.setScaleRange(this.width(),this.height());if(this.yAxisType()!=="none"){var o=s.append("g").attr("class",n?"y axis":"x axis").call(this.otherAxis),u=o.node().getBBox();r.left=u.width,r.top-=u.y}var a=this.width()-r.left-r.right;this.setScaleRange(a,this.height());var f=s.append("g").attr("class",n?"x axis":"y axis").attr("transform","translate("+r.left+","+i/2+")").call(this.currAxis);switch(this.xAxisOverlapMode()){case"rotate":case"stagger":case"hide":var l=[];f.selectAll(".tick > text").each(function(e){var t=this.getBoundingClientRect();for(var n=l.length-1;n>=0;--n){if(l[n].right<t.left)break;l.length+1-n>r.overlapModulus&&(r.overlapModulus=l.length+1-n)}l.push(t)})}this.adjustXAxisText(f,r);var c=f.node().getBBox();return r.right-=a-(c.x+c.width),r.bottom=c.height,this.setScaleRange(this.width()-r.left-r.right,this.height()-r.top-r.bottom),s.remove(),r},r.prototype.updateRegions=function(t,n,r){var i=this,s=this.svgRegions.selectAll(".region").data(this.regions());s.enter().append("rect").attr("class","region"),r?s.attr("x",function(e){return i.dataPos(e.x0)}).attr("y",0).attr("width",function(e){return i.dataPos(e.x1)-i.dataPos(e.x0)}).attr("height",this.height()).style("stroke",function(e){return i._palette(e.colorID)}).style("fill",function(t){return e.hsl(i._palette(t.colorID)).brighter()}):s.attr("x",0).attr("y",function(e){return i.dataPos(e.x0)}).attr("width",this.width()).attr("height",function(e){return i.dataPos(e.x0)-i.dataPos(e.x1)}).style("stroke",function(e){return i._palette(e.colorID)}).style("fill",function(t){return e.hsl(i._palette(t.colorID)).brighter()}),s.exit().remove()},r.prototype.update=function(t,r){var i=this,s=this.orientation()==="horizontal";this.updateRegions(t,r,s);switch(this.xAxisType()){case"linear":this.dataScale=e.scale.linear(),this.dataFormatter=e.format(this.xAxisTickFormat());break;case"time":this.dataScale=e.time.scale(),this.dataFormatter=this.xAxisTickFormat()?e.time.format(this.xAxisTickFormat()):null,this.sortDates()&&this.data(n.naturalSort(this.data(),"ascending",0));break;case"ordinal":default:this.dataScale=e.scale.ordinal(),this.dataFormatter=null}this.dataAxis.scale(this.dataScale).ticks(this.xAxisTickCount()).tickFormat(this.dataFormatter);switch(this.yAxisType()){case"pow":this.valueScale=e.scale.pow().exponent(this.yAxisTypePowExponent()),this.valueFormatter=e.format(this.yAxisTickFormat());break;case"log":this.valueScale=e.scale.log().base(this.yAxisTypeLogBase()),this.valueFormatter=e.format(this.yAxisTickFormat());break;case"time":this.valueScale=e.time.scale(),this.valueFormatter=this.yAxisTickFormat()?e.time.format(this.yAxisTickFormat()):null;break;case"linear":default:this.valueScale=e.scale.linear(),this.valueFormatter=e.format(this.yAxisTickFormat())}this.valueAxis.scale(this.valueScale).ticks(this.yAxisTickCount()).tickFormat(this.valueFormatter),this.dataAxis.orient(s?"bottom":"left"),this.valueAxis.orient(s?"left":"bottom"),this.currAxis=s?this.dataAxis:this.valueAxis,this.otherAxis=s?this.valueAxis:this.dataAxis,this.currScale=s?this.dataScale:this.valueScale,this.otherScale=s?this.valueScale:this.dataScale;var o=s?this.xBrush:this.yBrush,u=s?this.yBrush:this.xBrush,a=u.extent();switch(this.xAxisType()){case"ordinal":this.dataScale.domain(this.data().map(function(e){return e[0]}));break;default:var f=this.xAxisDomainLow()?this.formatData(this.xAxisDomainLow()):e.min(this.formattedData(),function(e){return e[0]}),l=this.xAxisDomainHigh()?this.formatData(this.xAxisDomainHigh()):e.max(this.formattedData(),function(e){return e[0]});this.dataScale.domain([f,l])}var c=this.yAxisDomainLow()?this.formatValue(this.yAxisDomainLow()):e.min(this.formattedData(),function(t){return e.min(t.filter(function(e,t){return t>0&&i.columns()[t]&&i.columns()[t].indexOf("__")!==0&&e!==null}),function(e){return e instanceof Array?e[0]:e})}),h=this.yAxisDomainHigh()?this.formatValue(this.yAxisDomainHigh()):e.max(this.formattedData(),function(t){return e.max(t.filter(function(e,t){return t>0&&i.columns()[t]&&i.columns()[t].indexOf("__")!==0&&e!==null}),function(e){return e instanceof Array?e[1]:e})});switch(this.yAxisType()){case"time":break;default:if(this.yAxisDomainLow()===""&&this.yAxisDomainHigh()===""){var p=(h-c)*this.yAxisDomainPadding()/100,d=c-p;if(c>=0&&d<0||c===h)d=0;c=d,h+=p}}this.valueScale.domain([c,h]),this.margin=this.calcMargin(t,r,s);var v=this.width()-this.margin.left-this.margin.right,m=this.height()-this.margin.top-this.margin.bottom,g=s?v:m,y=s?m:v;this.svg.transition().attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.svgXAxis.transition().attr("class",s?"x axis":"y axis").attr("transform","translate(0,"+m+")").call(this.currAxis),this.svgXAxisText.attr("x",v-2).text(s?this.columns()[0]:this.yAxisTitle()),this.svgYAxis.transition().style("visibility",this.yAxisType()==="none"?"hidden":null).attr("class",s?"y axis":"x axis").call(this.otherAxis).each(function(){i.adjustXAxisText(i.svgXAxis,i.margin)}),this.svgYAxisText.text(s?this.yAxisTitle():this.columns()[0]),this.xBrush.x(this.dataScale),this.yBrush.y(this.dataScale);if(this.selectionMode()){this._prevXAxisType!==this.xAxisType()&&(this._prevXAxisType=this.xAxisType(),this._prevBrush=null);if(!this._prevBrush)switch(this.xAxisType()){case"ordinal":o.extent([0,g]);break;default:o.extent(this.dataScale.domain())}else if(this._prevBrush&&this._prevBrush.orientation!==this.orientation())switch(this.xAxisType()){case"ordinal":o.extent([g-a[0]*g/this._prevBrush.maxCurrExtent,g-a[1]*g/this._prevBrush.maxCurrExtent]);break;default:o.extent(a)}this._prevBrush={orientation:this.orientation(),maxCurrExtent:g}}this.svgBrush.attr("transform","translate("+this.margin.left+", "+this.margin.top+")").style("display",this.selectionMode()?null:"none").call(o).selectAll(".background").transition().attr("width",v).attr("height",m),this.svgBrush.selectAll(".extent, .resize rect").transition().attr(s?"y":"x",0).attr(s?"height":"width",y);var b=this.svgBrush.selectAll(".resize").selectAll("path").data(function(e){return e});b.enter().append("path"),b.transition().attr("d",function(e){return i.resizeBrushHandle(e,v,m)}),this.updateChart(t,r,this.margin,v,m,s)},r.prototype.updateChart=function(e,t,n,r,i,s){},r.prototype.exit=function(e,n){t.prototype.exit.apply(this,arguments),delete this._selection},r.prototype.selection=function(e){console.log(e)},r});